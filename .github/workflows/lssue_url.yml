name: 智能API内容获取

on:
  schedule:
    # 每4小时运行一次
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      target:
        description: '目标格式'
        required: false
        default: 'clash'
        type: choice
        options:
        - clash
        - v2ray
        - singbox
        - surge
        - loon
        - quanx
        - surfboard
      list:
        description: '是否返回列表'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

env:
  API_BASE_URL: "https://proxy-manager-ggeu.onrender.com/api/v1/subscribe"
  GITHUB_ISSUE_URL: "https://github.com/wzdnzd/aggregator/issues/91"

jobs:
  fetch-content:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y curl jq
        
    - name: 爬取GitHub Issue获取最新配置
      id: scrape
      run: |
        echo "正在从GitHub Issue获取最新配置..."
        
        # 获取GitHub Issue页面内容
        ISSUE_CONTENT=$(curl -s -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/wzdnzd/aggregator/issues/91")
        
        # 提取issue body内容
        ISSUE_BODY=$(echo "$ISSUE_CONTENT" | jq -r '.body')
        
        echo "Issue内容获取成功"
        
        # 从issue内容中提取token（查找类似 l0b4i8i44u2kzlbh 的模式）
        TOKEN=$(echo "$ISSUE_BODY" | grep -oP '统一为`\K[^`]+' || echo "")
        
        # 如果没有找到，尝试其他模式
        if [ -z "$TOKEN" ]; then
          TOKEN=$(echo "$ISSUE_BODY" | grep -oP 'token.*?`\K[a-zA-Z0-9]+' || echo "")
        fi
        
        # 如果还是没找到，使用备用方法
        if [ -z "$TOKEN" ]; then
          TOKEN=$(echo "$ISSUE_BODY" | grep -oP '[a-z0-9]{12,16}' | head -1 || echo "l0b4i8i44u2kzlbh")
        fi
        
        # 设置默认值
        if [ -z "$TOKEN" ]; then
          TOKEN="l0b4i8i44u2kzlbh"
          echo "⚠️ 未能从Issue中提取token，使用默认值"
        else
          echo "✅ 成功提取token: $TOKEN"
        fi
        
        # 设置参数
        TARGET="${{ github.event.inputs.target || 'clash' }}"
        LIST="${{ github.event.inputs.list || 'false' }}"
        
        echo "token=$TOKEN" >> $GITHUB_OUTPUT
        echo "target=$TARGET" >> $GITHUB_OUTPUT
        echo "list=$LIST" >> $GITHUB_OUTPUT
        
        echo "使用参数: token=$TOKEN, target=$TARGET, list=$LIST"
        
        # 保存原始issue内容用于调试
        echo "$ISSUE_BODY" > issue_content.txt
        
    - name: 构建API链接并获取内容
      id: fetch
      run: |
        # 构建完整的API URL
        FULL_URL="${{ env.API_BASE_URL }}?token=${{ steps.scrape.outputs.token }}&target=${{ steps.scrape.outputs.target }}&list=${{ steps.scrape.outputs.list }}"
        
        echo "🔗 API链接: $FULL_URL"
        
        # 创建输出目录
        mkdir -p content
        mkdir -p logs
        
        # 记录请求信息
        echo "=== API请求信息 ===" > logs/request_log.txt
        echo "时间: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> logs/request_log.txt
        echo "Token: ${{ steps.scrape.outputs.token }}" >> logs/request_log.txt
        echo "Target: ${{ steps.scrape.outputs.target }}" >> logs/request_log.txt
        echo "List: ${{ steps.scrape.outputs.list }}" >> logs/request_log.txt
        echo "完整URL: $FULL_URL" >> logs/request_log.txt
        echo "" >> logs/request_log.txt
        
        # 发送请求并获取响应
        echo "正在请求API..."
        RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}\nTIME:%{time_total}" "$FULL_URL")
        
        # 解析响应
        HTTP_CODE=$(echo "$RESPONSE" | grep "HTTPSTATUS:" | cut -d: -f2)
        TIME_TOTAL=$(echo "$RESPONSE" | grep "TIME:" | cut -d: -f2)
        CONTENT=$(echo "$RESPONSE" | sed '/HTTPSTATUS:/d' | sed '/TIME:/d')
        
        echo "HTTP状态码: $HTTP_CODE"
        echo "请求耗时: ${TIME_TOTAL}秒"
        
        # 记录响应信息
        echo "HTTP状态码: $HTTP_CODE" >> logs/request_log.txt
        echo "请求耗时: ${TIME_TOTAL}秒" >> logs/request_log.txt
        echo "响应长度: $(echo "$CONTENT" | wc -c)字节" >> logs/request_log.txt
        
        if [ "$HTTP_CODE" -eq 200 ]; then
          # 根据target类型设置文件名
          FILENAME="content/${{ steps.scrape.outputs.target }}_config.txt"
          
          # 保存内容
          echo "$CONTENT" > "$FILENAME"
          
          # 添加元数据
          echo "" >> "$FILENAME"
          echo "# ==================== 获取信息 ====================" >> "$FILENAME"
          echo "# 更新时间: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> "$FILENAME"
          echo "# Token: ${{ steps.scrape.outputs.token }}" >> "$FILENAME"
          echo "# 目标格式: ${{ steps.scrape.outputs.target }}" >> "$FILENAME"
          echo "# 列表模式: ${{ steps.scrape.outputs.list }}" >> "$FILENAME"
          echo "# API地址: ${{ env.API_BASE_URL }}" >> "$FILENAME"
          echo "# GitHub Issue: ${{ env.GITHUB_ISSUE_URL }}" >> "$FILENAME"
          echo "# 请求耗时: ${TIME_TOTAL}秒" >> "$FILENAME"
          echo "# =================================================" >> "$FILENAME"
          
          echo "✅ 内容获取成功，保存到: $FILENAME"
          echo "📊 文件大小: $(wc -c < "$FILENAME") 字节"
          
          # 设置输出变量
          echo "filename=$FILENAME" >> $GITHUB_ENV
          echo "success=true" >> $GITHUB_ENV
          echo "file_size=$(wc -c < "$FILENAME")" >> $GITHUB_ENV
          
          # 记录成功信息
          echo "✅ 请求成功" >> logs/request_log.txt
          echo "文件保存: $FILENAME" >> logs/request_log.txt
          echo "文件大小: $(wc -c < "$FILENAME") 字节" >> logs/request_log.txt
          
        else
          echo "❌ API请求失败，HTTP状态码: $HTTP_CODE"
          echo "响应内容: $CONTENT"
          echo "success=false" >> $GITHUB_ENV
          
          # 记录错误信息
          echo "❌ 请求失败" >> logs/request_log.txt
          echo "错误内容: $CONTENT" >> logs/request_log.txt
          
          exit 1
        fi
        
    - name: 创建汇总报告
      if: env.success == 'true'
      run: |
        # 创建汇总文件
        SUMMARY_FILE="api_summary.md"
        
        cat > "$SUMMARY_FILE" << EOF
# API内容获取汇总报告
...
\`\`\`

## 使用说明
1. 配置文件已保存到 \`${{ env.filename }}\`
2. Token会自动从GitHub Issue中获取最新值
3. 每4小时自动更新一次
4. 支持手动触发更新

---
*由GitHub Actions自动生成*
EOF
        
        echo "📋 汇总报告已生成: $SUMMARY_FILE"
        
    - name: 验证内容质量
      if: env.success == 'true'
      run: |
        FILE="${{ env.filename }}"
        
        echo "🔍 验证内容质量..."
        
        # 检查文件大小
        SIZE=$(wc -c < "$FILE")
        if [ "$SIZE" -lt 100 ]; then
          echo "⚠️ 警告: 文件大小过小 ($SIZE 字节)，可能获取失败"
        else
          echo "✅ 文件大小正常: $SIZE 字节"
        fi
        
        # 检查是否包含有效内容（根据不同格式检查）
        case "${{ steps.scrape.outputs.target }}" in
          "clash")
            if grep -q "proxies:" "$FILE" || grep -q "proxy-groups:" "$FILE"; then
              echo "✅ Clash配置格式验证通过"
            else
              echo "⚠️ 警告: 未检测到有效的Clash配置内容"
            fi
            ;;
          "v2ray")
            if grep -q "outbounds" "$FILE" || grep -q "vmess://" "$FILE"; then
              echo "✅ V2Ray配置格式验证通过"
            else
              echo "⚠️ 警告: 未检测到有效的V2Ray配置内容"
            fi
            ;;
          *)
            echo "ℹ️ 跳过格式验证（格式: ${{ steps.scrape.outputs.target }}）"
            ;;
        esac
        
    - name: 提交更改
      if: env.success == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Actions Bot"
        
        # 添加所有生成的文件
        git add content/ logs/ api_summary.md issue_content.txt
        
        # 检查是否有更改
        if git diff --staged --quiet; then
          echo "📝 没有内容更改，跳过提交"
        else
          COMMIT_MSG="🤖 自动更新API内容 (${{ steps.scrape.outputs.target }}) - $(date '+%Y-%m-%d %H:%M:%S')"
          git commit -m "$COMMIT_MSG"
          git push
          echo "✅ 内容已更新并推送到仓库"
          echo "📁 文件位置: ${{ env.filename }}"
          echo "📋 汇总报告: api_summary.md"
        fi
        
    - name: 输出最终结果
      if: always()
      run: |
        echo "==================== 执行结果 ===================="
        if [ "${{ env.success }}" = "true" ]; then
          echo "🎉 任务执行成功！"
          echo "📄 配置文件: ${{ env.filename }}"
          echo "📊 文件大小: ${{ env.file_size }} 字节"
          echo "🔑 使用Token: ${{ steps.scrape.outputs.token }}"
          echo "🎯 目标格式: ${{ steps.scrape.outputs.target }}"
          echo "📋 汇总报告: api_summary.md"
          echo "📝 请求日志: logs/request_log.txt"
        else
          echo "❌ 任务执行失败"
          echo "🔍 请检查日志获取详细错误信息"
          echo "📝 请求日志: logs/request_log.txt"
        fi
        echo "================================================="
