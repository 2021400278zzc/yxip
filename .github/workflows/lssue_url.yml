name: æ™ºèƒ½APIå†…å®¹èŽ·å– (Clash + V2Ray)

on:
  push:
    branches:
      - main     # åªæœ‰ push åˆ° main åˆ†æ”¯æ‰ä¼šè§¦å‘
  schedule:
    # æ¯4å°æ—¶è¿è¡Œä¸€æ¬¡ (ä¸ŽèŠ‚ç‚¹æ›´æ–°å‘¨æœŸåŒæ­¥)
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      list:
        description: 'æ˜¯å¦è¿”å›žåˆ—è¡¨ (true/false)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

env:
  # GitHub Issue åœ°å€ (ä»Žæ­¤Issueä¸­åŠ¨æ€èŽ·å–APIåœ°å€å’ŒToken)
  GITHUB_ISSUE_URL: "https://github.com/wzdnzd/aggregator/issues/91"
  
  # é»˜è®¤å€¼ (å¦‚æžœæ— æ³•ä»ŽIssueä¸­æå–åˆ™ä½¿ç”¨ä»¥ä¸‹é»˜è®¤å€¼)
  DEFAULT_API_BASE_URL: "https://qybndbviblvt.us-west-1.clawcloudrun.com/api/v1/subscribe"
  DEFAULT_TOKEN: "75kg8oxf4z16rwnf58mm"

jobs:
  fetch-content:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y curl jq
        
    - name: çˆ¬å–GitHub IssueèŽ·å–æœ€æ–°é…ç½®
      id: scrape
      run: |
        echo "ðŸ” æ­£åœ¨ä»ŽGitHub IssueèŽ·å–æœ€æ–°é…ç½®..."
        
        # èŽ·å–GitHub Issueå†…å®¹
        ISSUE_CONTENT=$(curl -s -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/wzdnzd/aggregator/issues/91")
        
        ISSUE_BODY=$(echo "$ISSUE_CONTENT" | jq -r '.body')
        echo "âœ… Issueå†…å®¹èŽ·å–æˆåŠŸ"
        
        # ========== æå– API Base URL ==========
        echo "ðŸ”— æ­£åœ¨æå–APIåœ°å€..."
        
        # ç­–ç•¥1: ä»Žæ–¹æ‹¬å·é“¾æŽ¥ä¸­æå– [æ–‡æœ¬](URL)
        API_URL=$(echo "$ISSUE_BODY" | grep -oP '\]\(https://[^/]+/api/v1/subscribe' | sed 's/^](//' || echo "")
        
        # ç­–ç•¥2: ä»Žçº¯æ–‡æœ¬URLä¸­æå–
        if [ -z "$API_URL" ]; then
          API_URL=$(echo "$ISSUE_BODY" | grep -oP 'https://[^/\s]+/api/v1/subscribe' | head -1 || echo "")
        fi
        
        # ç­–ç•¥3: ä½¿ç”¨é»˜è®¤å€¼
        if [ -z "$API_URL" ]; then
          API_URL="${{ env.DEFAULT_API_BASE_URL }}"
          echo "âš ï¸ æœªèƒ½ä»ŽIssueä¸­æå–APIåœ°å€ï¼Œä½¿ç”¨é»˜è®¤å€¼: $API_URL"
        else
          echo "âœ… æˆåŠŸæå–APIåœ°å€: $API_URL"
        fi
        
        # ========== æå– Token ==========
        echo "ðŸ”‘ æ­£åœ¨æå–Token..."
        
        # ç­–ç•¥1: ä»Žä»£ç å—ä¸­æå– (ä¼˜å…ˆ)
        TOKEN=$(echo "$ISSUE_BODY" | grep -oP '```\s*\K[a-z0-9]{16,20}(?=\s*```)' | head -1 || echo "")
        
        # ç­–ç•¥2: ä»Žåå¼•å·åŒ…è£¹çš„tokenæå–
        if [ -z "$TOKEN" ]; then
          TOKEN=$(echo "$ISSUE_BODY" | grep -oP '`\K[a-z0-9]{16,20}(?=`)' | head -1 || echo "")
        fi
        
        # ç­–ç•¥3: ä»Ž "ç»Ÿä¸€ä¸º`xxx`" æ ¼å¼æå–
        if [ -z "$TOKEN" ]; then
          TOKEN=$(echo "$ISSUE_BODY" | grep -oP 'ç»Ÿä¸€ä¸º`\K[^`]+' || echo "")
        fi
        
        # ç­–ç•¥4: é€šç”¨æ¨¡å¼åŒ¹é… (16-20ä½å°å†™å­—æ¯æ•°å­—ç»„åˆ)
        if [ -z "$TOKEN" ]; then
          TOKEN=$(echo "$ISSUE_BODY" | grep -oP '\b[a-z0-9]{16,20}\b' | head -1 || echo "")
        fi
        
        # ä½¿ç”¨é»˜è®¤å€¼
        if [ -z "$TOKEN" ]; then
          TOKEN="${{ env.DEFAULT_TOKEN }}"
          echo "âš ï¸ æœªèƒ½ä»ŽIssueä¸­æå–tokenï¼Œä½¿ç”¨é»˜è®¤å€¼: $TOKEN"
        else
          echo "âœ… æˆåŠŸæå–token: $TOKEN"
        fi
        
        LIST="${{ github.event.inputs.list || 'false' }}"
        
        # è¾“å‡ºæå–çš„å‚æ•°
        echo "api_url=$API_URL" >> $GITHUB_OUTPUT
        echo "token=$TOKEN" >> $GITHUB_OUTPUT
        echo "list=$LIST" >> $GITHUB_OUTPUT
        
        echo "ðŸ“‹ ========== æœ€ç»ˆä½¿ç”¨å‚æ•° =========="
        echo "ðŸ”— APIåœ°å€: $API_URL"
        echo "ðŸ”‘ Token: $TOKEN"
        echo "ðŸ“ List: $LIST"
        echo "ðŸŽ¯ ç›®æ ‡æ ¼å¼: clash, v2ray"
        echo "====================================="
        
        # ä¿å­˜Issueå®Œæ•´å†…å®¹ä¾›è°ƒè¯•
        echo "$ISSUE_BODY" > issue_content.txt
        
    - name: æž„å»ºAPIé“¾æŽ¥å¹¶èŽ·å–å†…å®¹ (Clash + V2Ray)
      id: fetch
      run: |
        mkdir -p content
        mkdir -p logs
        
        # å®šä¹‰éœ€è¦èŽ·å–çš„æ ¼å¼åˆ—è¡¨
        TARGETS=("clash" "v2ray")
        LIST="${{ steps.scrape.outputs.list }}"
        
        # è®°å½•æ€»ä½“è¯·æ±‚ä¿¡æ¯
        echo "==================== APIæ‰¹é‡è¯·æ±‚ä¿¡æ¯ ====================" > logs/request_log.txt
        echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> logs/request_log.txt
        echo "APIåœ°å€: ${{ steps.scrape.outputs.api_url }}" >> logs/request_log.txt
        echo "Token: ${{ steps.scrape.outputs.token }}" >> logs/request_log.txt
        echo "ç›®æ ‡æ ¼å¼: ${TARGETS[@]}" >> logs/request_log.txt
        echo "åˆ—è¡¨æ¨¡å¼: $LIST" >> logs/request_log.txt
        echo "========================================================" >> logs/request_log.txt
        echo "" >> logs/request_log.txt
        
        SUCCESS_COUNT=0
        FAIL_COUNT=0
        ALL_FILES=""
        TOTAL_SIZE=0
        
        # å¾ªçŽ¯èŽ·å–æ¯ç§æ ¼å¼
        for TARGET in "${TARGETS[@]}"; do
          echo ""
          echo "ðŸŽ¯ ========== æ­£åœ¨èŽ·å– $TARGET æ ¼å¼ =========="
          
          FULL_URL="${{ steps.scrape.outputs.api_url }}?token=${{ steps.scrape.outputs.token }}&target=$TARGET&list=$LIST"
          echo "ðŸ”— APIé“¾æŽ¥: $FULL_URL"
          
          # è®°å½•å½“å‰æ ¼å¼è¯·æ±‚ä¿¡æ¯
          echo "--- $TARGET æ ¼å¼ ---" >> logs/request_log.txt
          echo "å®Œæ•´URL: $FULL_URL" >> logs/request_log.txt
          
          # å‘é€APIè¯·æ±‚
          echo "ðŸš€ æ­£åœ¨è¯·æ±‚API..."
          RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}\nTIME:%{time_total}" "$FULL_URL")
          
          # è§£æžå“åº”
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTPSTATUS:" | cut -d: -f2)
          TIME_TOTAL=$(echo "$RESPONSE" | grep "TIME:" | cut -d: -f2)
          CONTENT=$(echo "$RESPONSE" | sed '/HTTPSTATUS:/d' | sed '/TIME:/d')
          
          echo "ðŸ“Š HTTPçŠ¶æ€ç : $HTTP_CODE"
          echo "â±ï¸ è¯·æ±‚è€—æ—¶: ${TIME_TOTAL}ç§’"
          
          # è®°å½•å“åº”ä¿¡æ¯
          echo "HTTPçŠ¶æ€ç : $HTTP_CODE" >> logs/request_log.txt
          echo "è¯·æ±‚è€—æ—¶: ${TIME_TOTAL}ç§’" >> logs/request_log.txt
          echo "å“åº”é•¿åº¦: $(echo "$CONTENT" | wc -c)å­—èŠ‚" >> logs/request_log.txt
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            FILENAME="content/${TARGET}_config.txt"
            echo "$CONTENT" > "$FILENAME"
            
            # è¿½åŠ å…ƒæ•°æ®ä¿¡æ¯
            echo "" >> "$FILENAME"
            echo "# ==================== èŽ·å–ä¿¡æ¯ ====================" >> "$FILENAME"
            echo "# æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> "$FILENAME"
            echo "# APIåœ°å€: ${{ steps.scrape.outputs.api_url }}" >> "$FILENAME"
            echo "# Token: ${{ steps.scrape.outputs.token }}" >> "$FILENAME"
            echo "# ç›®æ ‡æ ¼å¼: $TARGET" >> "$FILENAME"
            echo "# åˆ—è¡¨æ¨¡å¼: $LIST" >> "$FILENAME"
            echo "# GitHub Issue: ${{ env.GITHUB_ISSUE_URL }}" >> "$FILENAME"
            echo "# è¯·æ±‚è€—æ—¶: ${TIME_TOTAL}ç§’" >> "$FILENAME"
            echo "# èŠ‚ç‚¹è¯´æ˜Ž: æ¯æ¬¡éšæœºè¿”å›ž100ä¸ªèŠ‚ç‚¹ï¼Œæ¯4å°æ—¶æ›´æ–°" >> "$FILENAME"
            echo "# ==================================================" >> "$FILENAME"
            
            FILE_SIZE=$(wc -c < "$FILENAME")
            echo "âœ… $TARGET æ ¼å¼èŽ·å–æˆåŠŸï¼Œä¿å­˜åˆ°: $FILENAME"
            echo "ðŸ“Š æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
            
            ALL_FILES="$ALL_FILES $FILENAME"
            TOTAL_SIZE=$((TOTAL_SIZE + FILE_SIZE))
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            
            # è®°å½•æˆåŠŸä¿¡æ¯
            echo "âœ… è¯·æ±‚æˆåŠŸ" >> logs/request_log.txt
            echo "æ–‡ä»¶ä¿å­˜: $FILENAME" >> logs/request_log.txt
            echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚" >> logs/request_log.txt
          else
            echo "âŒ $TARGET æ ¼å¼è¯·æ±‚å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : $HTTP_CODE"
            echo "ðŸ“„ å“åº”å†…å®¹: $CONTENT"
            FAIL_COUNT=$((FAIL_COUNT + 1))
            
            # è®°å½•å¤±è´¥ä¿¡æ¯
            echo "âŒ è¯·æ±‚å¤±è´¥" >> logs/request_log.txt
            echo "é”™è¯¯å†…å®¹: $CONTENT" >> logs/request_log.txt
          fi
          
          echo "" >> logs/request_log.txt
          
          # çŸ­æš‚å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
          sleep 2
        done
        
        # æ±‡æ€»ç»“æžœ
        echo ""
        echo "ï¿½ ========== æ‰¹é‡èŽ·å–æ±‡æ€» =========="
        echo "âœ… æˆåŠŸ: $SUCCESS_COUNT ä¸ªæ ¼å¼"
        echo "âŒ å¤±è´¥: $FAIL_COUNT ä¸ªæ ¼å¼"
        echo "ðŸ“ æ€»æ–‡ä»¶æ•°: $SUCCESS_COUNT"
        echo "ðŸ’¾ æ€»å¤§å°: $TOTAL_SIZE å­—èŠ‚"
        echo "====================================="
        
        # ä¿å­˜çŽ¯å¢ƒå˜é‡
        echo "filenames=$ALL_FILES" >> $GITHUB_ENV
        echo "total_size=$TOTAL_SIZE" >> $GITHUB_ENV
        echo "success_count=$SUCCESS_COUNT" >> $GITHUB_ENV
        echo "fail_count=$FAIL_COUNT" >> $GITHUB_ENV
        
        if [ $SUCCESS_COUNT -gt 0 ]; then
          echo "success=true" >> $GITHUB_ENV
        else
          echo "success=false" >> $GITHUB_ENV
          exit 1
        fi
        
    - name: åˆ›å»ºæ±‡æ€»æŠ¥å‘Š
      if: env.success == 'true'
      run: |
        SUMMARY_FILE="api_summary.md"
        cat > "$SUMMARY_FILE" << 'EOF'
        # ðŸ”¥ APIå†…å®¹èŽ·å–æ±‡æ€»æŠ¥å‘Š
        
        ## ðŸ“‹ åŸºæœ¬ä¿¡æ¯
        - **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        - **Token**: ${{ steps.scrape.outputs.token }}
        - **èŽ·å–æ ¼å¼**: Clash + V2Ray
        - **åˆ—è¡¨æ¨¡å¼**: ${{ steps.scrape.outputs.list }}
        - **æˆåŠŸæ•°é‡**: ${{ env.success_count }} ä¸ªæ ¼å¼
        - **å¤±è´¥æ•°é‡**: ${{ env.fail_count }} ä¸ªæ ¼å¼
        - **æ€»æ–‡ä»¶å¤§å°**: ${{ env.total_size }} å­—èŠ‚
        
        ## ðŸ”— APIä¿¡æ¯
        - **åŸºç¡€URL**: ${{ steps.scrape.outputs.api_url }}
        - **GitHub Issue**: ${{ env.GITHUB_ISSUE_URL }}
        - **ç”Ÿæˆæ–‡ä»¶**: ${{ env.filenames }}
        - **èŠ‚ç‚¹æ•°é‡**: æ¯æ¬¡éšæœºè¿”å›ž100ä¸ªèŠ‚ç‚¹
        - **æ›´æ–°é¢‘çŽ‡**: æ¯4å°æ—¶è‡ªåŠ¨æ›´æ–°
        
        ## ðŸ“„ æ–‡ä»¶åˆ—è¡¨
        - âœ… `content/clash_config.txt` - Clash æ ¼å¼é…ç½®
        - âœ… `content/v2ray_config.txt` - V2Ray æ ¼å¼é…ç½®
        
        ## ðŸ“– ä½¿ç”¨è¯´æ˜Ž
        1. âœ… æ¯æ¬¡è¿è¡Œè‡ªåŠ¨èŽ·å– Clash å’Œ V2Ray ä¸¤ç§æ ¼å¼
        2. ðŸ”„ APIåœ°å€å’ŒTokenä¼šè‡ªåŠ¨ä»ŽGitHub Issueä¸­èŽ·å–æœ€æ–°å€¼
        3. â° æ¯4å°æ—¶è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡ (ä¸ŽèŠ‚ç‚¹æ›´æ–°åŒæ­¥)
        4. ðŸ–±ï¸ æ”¯æŒæ‰‹åŠ¨è§¦å‘æ›´æ–° (Actionsé¡µé¢)
        5. ðŸ“¤ pushåˆ°mainåˆ†æ”¯ä¹Ÿä¼šè§¦å‘æ›´æ–°
        6. ðŸŽ² æ¯æ¬¡èŽ·å–éšæœº100ä¸ªèŠ‚ç‚¹ï¼Œé¿å…æ‹¥æŒ¤
        
        ## âš ï¸ æ³¨æ„äº‹é¡¹
        - ä½Žè°ƒä½¿ç”¨ï¼Œç¦æ­¢å¤§èŒƒå›´ä¼ æ’­
        - Tokenä¼šåœ¨å¤§èŒƒå›´åˆ†äº«æ—¶è¢«é‡ç½®
        - ä»…ä¾›ç§‘ç ”ã€æ•™è‚²ä½¿ç”¨
        - è¯·éµå¾ªæ‚¨æ‰€åœ¨å›½å®¶å’Œåœ°åŒºçš„æ³•å¾‹æ³•è§„
        
        ---
        *ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ | æ•°æ®æ¥æº: [wzdnzd/aggregator#91](${{ env.GITHUB_ISSUE_URL }})*
        EOF
        echo "ðŸ“‹ æ±‡æ€»æŠ¥å‘Šå·²ç”Ÿæˆ: $SUMMARY_FILE"
        
    - name: æäº¤æ›´æ”¹
      if: env.success == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Actions Bot"
        
        git add content/ logs/ api_summary.md issue_content.txt
        if git diff --staged --quiet; then
          echo "ðŸ“ æ²¡æœ‰å†…å®¹æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
        else
          COMMIT_MSG="ðŸ¤– è‡ªåŠ¨æ›´æ–°APIå†…å®¹ (Clash + V2Ray) - $(date '+%Y-%m-%d %H:%M:%S')"
          git commit -m "$COMMIT_MSG"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push origin HEAD:${{ github.ref_name }}
          echo "âœ… å†…å®¹å·²æ›´æ–°å¹¶æŽ¨é€åˆ°ä»“åº“"
        fi
        
    - name: è¾“å‡ºæœ€ç»ˆç»“æžœ
      if: always()
      run: |
        echo "==================== æ‰§è¡Œç»“æžœ ===================="
        if [ "${{ env.success }}" = "true" ]; then
          echo "ðŸŽ‰ ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼"
          echo "ðŸ”— APIåœ°å€: ${{ steps.scrape.outputs.api_url }}"
          echo "ðŸ”‘ ä½¿ç”¨Token: ${{ steps.scrape.outputs.token }}"
          echo "ðŸŽ¯ èŽ·å–æ ¼å¼: Clash + V2Ray"
          echo "âœ… æˆåŠŸ: ${{ env.success_count }} ä¸ª"
          echo "âŒ å¤±è´¥: ${{ env.fail_count }} ä¸ª"
          echo "ï¿½ ç”Ÿæˆæ–‡ä»¶: ${{ env.filenames }}"
          echo "ï¿½ æ€»å¤§å°: ${{ env.total_size }} å­—èŠ‚"
          echo "ðŸ“‹ æ±‡æ€»æŠ¥å‘Š: api_summary.md"
          echo "ðŸ“ è¯·æ±‚æ—¥å¿—: logs/request_log.txt"
          echo "ðŸŽ² èŠ‚ç‚¹è¯´æ˜Ž: æ¯æ ¼å¼éšæœºè¿”å›ž100ä¸ªï¼Œæ¯4å°æ—¶æ›´æ–°"
        else
          echo "âŒ ä»»åŠ¡æ‰§è¡Œå¤±è´¥"
          echo "ðŸ” è¯·æ£€æŸ¥æ—¥å¿—èŽ·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          echo "ðŸ“ è¯·æ±‚æ—¥å¿—: logs/request_log.txt"
        fi
        echo "=================================================="
