name: Êô∫ËÉΩAPIÂÜÖÂÆπËé∑Âèñ (Clash + V2Ray)

on:
  push:
    branches:
      - main     # Âè™Êúâ push Âà∞ main ÂàÜÊîØÊâç‰ºöËß¶Âèë
  schedule:
    # ÊØè4Â∞èÊó∂ËøêË°å‰∏ÄÊ¨° (‰∏éËäÇÁÇπÊõ¥Êñ∞Âë®ÊúüÂêåÊ≠•)
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      list:
        description: 'ÊòØÂê¶ËøîÂõûÂàóË°® (true/false)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

env:
  # GitHub Issue Âú∞ÂùÄ (‰ªéÊ≠§Issue‰∏≠Âä®ÊÄÅËé∑ÂèñAPIÂú∞ÂùÄÂíåToken)
  GITHUB_ISSUE_URL: "https://github.com/wzdnzd/aggregator/issues/91"
  
  # ÈªòËÆ§ÂÄº (Â¶ÇÊûúÊó†Ê≥ï‰ªéIssue‰∏≠ÊèêÂèñÂàô‰ΩøÁî®‰ª•‰∏ãÈªòËÆ§ÂÄº)
  DEFAULT_API_BASE_URL: "https://qybndbviblvt.us-west-1.clawcloudrun.com/api/v1/subscribe"
  DEFAULT_TOKEN: "75kg8oxf4z16rwnf58mm"

jobs:
  fetch-content:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
    - name: Ê£ÄÂá∫‰ª£Á†Å
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: ÂÆâË£Ö‰æùËµñ
      run: |
        sudo apt-get update
        sudo apt-get install -y curl jq
        
    - name: Áà¨ÂèñGitHub IssueËé∑ÂèñÊúÄÊñ∞ÈÖçÁΩÆ
      id: scrape
      run: |
        echo "üîç Ê≠£Âú®‰ªéGitHub IssueËé∑ÂèñÊúÄÊñ∞ÈÖçÁΩÆ..."
        
        # Ëé∑ÂèñGitHub IssueÂÜÖÂÆπ
        ISSUE_CONTENT=$(curl -s -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/wzdnzd/aggregator/issues/91")
        
        ISSUE_BODY=$(echo "$ISSUE_CONTENT" | jq -r '.body')
        echo "‚úÖ IssueÂÜÖÂÆπËé∑ÂèñÊàêÂäü"
        
        # ========== ÊèêÂèñ API Base URL ==========
        echo "üîó Ê≠£Âú®ÊèêÂèñAPIÂú∞ÂùÄ..."
        
        # Á≠ñÁï•1: ‰ªéÊñπÊã¨Âè∑ÈìæÊé•‰∏≠ÊèêÂèñ [ÊñáÊú¨](URL)
        API_URL=$(echo "$ISSUE_BODY" | grep -oP '\]\(https://[^/]+/api/v1/subscribe' | sed 's/^](//' || echo "")
        
        # Á≠ñÁï•2: ‰ªéÁ∫ØÊñáÊú¨URL‰∏≠ÊèêÂèñ
        if [ -z "$API_URL" ]; then
          API_URL=$(echo "$ISSUE_BODY" | grep -oP 'https://[^/\s]+/api/v1/subscribe' | head -1 || echo "")
        fi
        
        # Á≠ñÁï•3: ‰ΩøÁî®ÈªòËÆ§ÂÄº
        if [ -z "$API_URL" ]; then
          API_URL="${{ env.DEFAULT_API_BASE_URL }}"
          echo "‚ö†Ô∏è Êú™ËÉΩ‰ªéIssue‰∏≠ÊèêÂèñAPIÂú∞ÂùÄÔºå‰ΩøÁî®ÈªòËÆ§ÂÄº: $API_URL"
        else
          echo "‚úÖ ÊàêÂäüÊèêÂèñAPIÂú∞ÂùÄ: $API_URL"
        fi
        
        # ========== ÊèêÂèñ Token ==========
        echo "üîë Ê≠£Âú®ÊèêÂèñToken..."
        
        # Á≠ñÁï•1: ‰ªé‰ª£Á†ÅÂùó‰∏≠ÊèêÂèñ (‰ºòÂÖà)
        TOKEN=$(echo "$ISSUE_BODY" | grep -oP '```\s*\K[a-z0-9]{16,20}(?=\s*```)' | head -1 || echo "")
        
        # Á≠ñÁï•2: ‰ªéÂèçÂºïÂè∑ÂåÖË£πÁöÑtokenÊèêÂèñ
        if [ -z "$TOKEN" ]; then
          TOKEN=$(echo "$ISSUE_BODY" | grep -oP '`\K[a-z0-9]{16,20}(?=`)' | head -1 || echo "")
        fi
        
        # Á≠ñÁï•3: ‰ªé "Áªü‰∏Ä‰∏∫`xxx`" Ê†ºÂºèÊèêÂèñ
        if [ -z "$TOKEN" ]; then
          TOKEN=$(echo "$ISSUE_BODY" | grep -oP 'Áªü‰∏Ä‰∏∫`\K[^`]+' || echo "")
        fi
        
        # Á≠ñÁï•4: ÈÄöÁî®Ê®°ÂºèÂåπÈÖç (16-20‰ΩçÂ∞èÂÜôÂ≠óÊØçÊï∞Â≠óÁªÑÂêà)
        if [ -z "$TOKEN" ]; then
          TOKEN=$(echo "$ISSUE_BODY" | grep -oP '\b[a-z0-9]{16,20}\b' | head -1 || echo "")
        fi
        
        # ‰ΩøÁî®ÈªòËÆ§ÂÄº
        if [ -z "$TOKEN" ]; then
          TOKEN="${{ env.DEFAULT_TOKEN }}"
          echo "‚ö†Ô∏è Êú™ËÉΩ‰ªéIssue‰∏≠ÊèêÂèñtokenÔºå‰ΩøÁî®ÈªòËÆ§ÂÄº: $TOKEN"
        else
          echo "‚úÖ ÊàêÂäüÊèêÂèñtoken: $TOKEN"
        fi
        
        LIST="${{ github.event.inputs.list || 'false' }}"
        
        # ËæìÂá∫ÊèêÂèñÁöÑÂèÇÊï∞
        echo "api_url=$API_URL" >> $GITHUB_OUTPUT
        echo "token=$TOKEN" >> $GITHUB_OUTPUT
        echo "list=$LIST" >> $GITHUB_OUTPUT
        
        echo "üìã ========== ÊúÄÁªà‰ΩøÁî®ÂèÇÊï∞ =========="
        echo "üîó APIÂú∞ÂùÄ: $API_URL"
        echo "üîë Token: $TOKEN"
        echo "üìù List: $LIST"
        echo "üéØ ÁõÆÊ†áÊ†ºÂºè: clash, v2ray"
        echo "====================================="
        
        # ‰øùÂ≠òIssueÂÆåÊï¥ÂÜÖÂÆπ‰æõË∞ÉËØï
        echo "$ISSUE_BODY" > issue_content.txt
        
    - name: ÊûÑÂª∫APIÈìæÊé•Âπ∂Ëé∑ÂèñÂÜÖÂÆπ (Clash + V2Ray)
      id: fetch
      run: |
        mkdir -p content
        mkdir -p logs
        
        # ÂÆö‰πâÈúÄË¶ÅËé∑ÂèñÁöÑÊ†ºÂºèÂàóË°®
        TARGETS=("clash" "v2ray")
        LIST="${{ steps.scrape.outputs.list }}"
        
        # ËÆ∞ÂΩïÊÄª‰ΩìËØ∑Ê±Ç‰ø°ÊÅØ
        echo "==================== APIÊâπÈáèËØ∑Ê±Ç‰ø°ÊÅØ ====================" > logs/request_log.txt
        echo "Êó∂Èó¥: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> logs/request_log.txt
        echo "APIÂú∞ÂùÄ: ${{ steps.scrape.outputs.api_url }}" >> logs/request_log.txt
        echo "Token: ${{ steps.scrape.outputs.token }}" >> logs/request_log.txt
        echo "ÁõÆÊ†áÊ†ºÂºè: ${TARGETS[@]}" >> logs/request_log.txt
        echo "ÂàóË°®Ê®°Âºè: $LIST" >> logs/request_log.txt
        echo "========================================================" >> logs/request_log.txt
        echo "" >> logs/request_log.txt
        
        SUCCESS_COUNT=0
        FAIL_COUNT=0
        ALL_FILES=""
        TOTAL_SIZE=0
        
        # Âæ™ÁéØËé∑ÂèñÊØèÁßçÊ†ºÂºè
        for TARGET in "${TARGETS[@]}"; do
          echo ""
          echo "üéØ ========== Ê≠£Âú®Ëé∑Âèñ $TARGET Ê†ºÂºè =========="
          
          FULL_URL="${{ steps.scrape.outputs.api_url }}?token=${{ steps.scrape.outputs.token }}&target=$TARGET&list=$LIST"
          echo "üîó APIÈìæÊé•: $FULL_URL"
          
          # ËÆ∞ÂΩïÂΩìÂâçÊ†ºÂºèËØ∑Ê±Ç‰ø°ÊÅØ
          echo "--- $TARGET Ê†ºÂºè ---" >> logs/request_log.txt
          echo "ÂÆåÊï¥URL: $FULL_URL" >> logs/request_log.txt
          
          # Áõ¥Êé•‰øùÂ≠òAPIÂìçÂ∫îÂà∞ÊúÄÁªàÊñá‰ª∂
          FILENAME="content/${TARGET}_config.txt"
          
          echo "üöÄ Ê≠£Âú®ËØ∑Ê±ÇAPIÂπ∂‰øùÂ≠ò..."
          
          # ‰ΩøÁî®curlÁõ¥Êé•‰∏ãËΩΩÂÜÖÂÆπÂà∞Êñá‰ª∂ÔºåÂπ∂Ëé∑ÂèñHTTPÁä∂ÊÄÅÁ†Å
          HTTP_CODE=$(curl -s -w "%{http_code}" -o "$FILENAME" "$FULL_URL")
          
          echo "üìä HTTPÁä∂ÊÄÅÁ†Å: $HTTP_CODE"
          
          # ËÆ∞ÂΩïÂìçÂ∫î‰ø°ÊÅØ
          echo "HTTPÁä∂ÊÄÅÁ†Å: $HTTP_CODE" >> logs/request_log.txt
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            # Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è
            FILE_SIZE=$(wc -c < "$FILENAME" 2>/dev/null || echo "0")
            echo "üì¶ Êñá‰ª∂Â§ßÂ∞è: $FILE_SIZE Â≠óËäÇ"
            echo "Êñá‰ª∂Â§ßÂ∞è: $FILE_SIZE Â≠óËäÇ" >> logs/request_log.txt
            
            if [ "$FILE_SIZE" -gt 0 ]; then
              echo "‚úÖ $TARGET Ê†ºÂºèËé∑ÂèñÊàêÂäüÔºå‰øùÂ≠òÂà∞: $FILENAME"
              
              ALL_FILES="$ALL_FILES $FILENAME"
              TOTAL_SIZE=$((TOTAL_SIZE + FILE_SIZE))
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              
              # ËÆ∞ÂΩïÊàêÂäü‰ø°ÊÅØ
              echo "‚úÖ ËØ∑Ê±ÇÊàêÂäü" >> logs/request_log.txt
              echo "Êñá‰ª∂‰øùÂ≠ò: $FILENAME" >> logs/request_log.txt
            else
              echo "‚ö†Ô∏è $TARGET Ê†ºÂºèÂÜÖÂÆπ‰∏∫Á©∫"
              FAIL_COUNT=$((FAIL_COUNT + 1))
              echo "‚ö†Ô∏è ÂÜÖÂÆπ‰∏∫Á©∫" >> logs/request_log.txt
              # Âà†Èô§Á©∫Êñá‰ª∂
              rm -f "$FILENAME"
            fi
          else
            echo "‚ùå $TARGET Ê†ºÂºèËØ∑Ê±ÇÂ§±Ë¥•ÔºåHTTPÁä∂ÊÄÅÁ†Å: $HTTP_CODE"
            FAIL_COUNT=$((FAIL_COUNT + 1))
            
            # ËÆ∞ÂΩïÂ§±Ë¥•‰ø°ÊÅØ
            echo "‚ùå ËØ∑Ê±ÇÂ§±Ë¥•" >> logs/request_log.txt
            
            # Âà†Èô§Â§±Ë¥•ÁöÑÊñá‰ª∂
            rm -f "$FILENAME"
          fi
          
          echo "" >> logs/request_log.txt
          
          # Áü≠ÊöÇÂª∂ËøüÈÅøÂÖçËØ∑Ê±ÇËøáÂø´
          sleep 2
        done
        
        # Ê±áÊÄªÁªìÊûú
        echo ""
        echo "üìä ========== ÊâπÈáèËé∑ÂèñÊ±áÊÄª =========="
        echo "‚úÖ ÊàêÂäü: $SUCCESS_COUNT ‰∏™Ê†ºÂºè"
        echo "‚ùå Â§±Ë¥•: $FAIL_COUNT ‰∏™Ê†ºÂºè"
        echo "üìÅ ÊÄªÊñá‰ª∂Êï∞: $SUCCESS_COUNT"
        echo "üíæ ÊÄªÂ§ßÂ∞è: $TOTAL_SIZE Â≠óËäÇ"
        echo "====================================="
        
        # ‰øùÂ≠òÁéØÂ¢ÉÂèòÈáè
        echo "filenames=$ALL_FILES" >> $GITHUB_ENV
        echo "total_size=$TOTAL_SIZE" >> $GITHUB_ENV
        echo "success_count=$SUCCESS_COUNT" >> $GITHUB_ENV
        echo "fail_count=$FAIL_COUNT" >> $GITHUB_ENV
        
        if [ $SUCCESS_COUNT -gt 0 ]; then
          echo "success=true" >> $GITHUB_ENV
        else
          echo "success=false" >> $GITHUB_ENV
          exit 1
        fi
        
    - name: ÂàõÂª∫Ê±áÊÄªÊä•Âëä
      if: env.success == 'true'
      run: |
        SUMMARY_FILE="api_summary.md"
        cat > "$SUMMARY_FILE" << 'EOF'
        # üî• APIÂÜÖÂÆπËé∑ÂèñÊ±áÊÄªÊä•Âëä
        
        ## üìã Âü∫Êú¨‰ø°ÊÅØ
        - **Êõ¥Êñ∞Êó∂Èó¥**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        - **Token**: ${{ steps.scrape.outputs.token }}
        - **Ëé∑ÂèñÊ†ºÂºè**: Clash + V2Ray
        - **ÂàóË°®Ê®°Âºè**: ${{ steps.scrape.outputs.list }}
        - **ÊàêÂäüÊï∞Èáè**: ${{ env.success_count }} ‰∏™Ê†ºÂºè
        - **Â§±Ë¥•Êï∞Èáè**: ${{ env.fail_count }} ‰∏™Ê†ºÂºè
        - **ÊÄªÊñá‰ª∂Â§ßÂ∞è**: ${{ env.total_size }} Â≠óËäÇ
        
        ## üîó API‰ø°ÊÅØ
        - **Âü∫Á°ÄURL**: ${{ steps.scrape.outputs.api_url }}
        - **GitHub Issue**: ${{ env.GITHUB_ISSUE_URL }}
        - **ÁîüÊàêÊñá‰ª∂**: ${{ env.filenames }}
        - **ËäÇÁÇπÊï∞Èáè**: ÊØèÊ¨°ÈöèÊú∫ËøîÂõû100‰∏™ËäÇÁÇπ
        - **Êõ¥Êñ∞È¢ëÁéá**: ÊØè4Â∞èÊó∂Ëá™Âä®Êõ¥Êñ∞
        
        ## üìÑ Êñá‰ª∂ÂàóË°®
        - ‚úÖ `content/clash_config.txt` - Clash Ê†ºÂºèÈÖçÁΩÆÔºàÁ∫ØÂáÄÔºåÊó†Ê≥®ÈáäÔºâ
        - ‚úÖ `content/v2ray_config.txt` - V2Ray Ê†ºÂºèÈÖçÁΩÆÔºàÁ∫ØÂáÄÔºåÊó†Ê≥®ÈáäÔºâ
        
        ## üìñ ‰ΩøÁî®ËØ¥Êòé
        1. ‚úÖ ÊØèÊ¨°ËøêË°åËá™Âä®Ëé∑Âèñ Clash Âíå V2Ray ‰∏§ÁßçÊ†ºÂºè
        2. üîÑ APIÂú∞ÂùÄÂíåToken‰ºöËá™Âä®‰ªéGitHub Issue‰∏≠Ëé∑ÂèñÊúÄÊñ∞ÂÄº
        3. ‚è∞ ÊØè4Â∞èÊó∂Ëá™Âä®Êõ¥Êñ∞‰∏ÄÊ¨° (‰∏éËäÇÁÇπÊõ¥Êñ∞ÂêåÊ≠•)
        4. üñ±Ô∏è ÊîØÊåÅÊâãÂä®Ëß¶ÂèëÊõ¥Êñ∞ (ActionsÈ°µÈù¢)
        5. üì§ pushÂà∞mainÂàÜÊîØ‰πü‰ºöËß¶ÂèëÊõ¥Êñ∞
        6. üé≤ ÊØèÊ¨°Ëé∑ÂèñÈöèÊú∫100‰∏™ËäÇÁÇπÔºåÈÅøÂÖçÊã•Êå§
        7. üìù ÈÖçÁΩÆÊñá‰ª∂‰∏∫Á∫ØÂáÄAPIÂìçÂ∫îÔºå‰∏çÂåÖÂê´‰ªª‰ΩïÈ¢ùÂ§ñÊ≥®Èáä
        
        ## ‚ö†Ô∏è Ê≥®ÊÑè‰∫ãÈ°π
        - ‰ΩéË∞É‰ΩøÁî®ÔºåÁ¶ÅÊ≠¢Â§ßËåÉÂõ¥‰º†Êí≠
        - Token‰ºöÂú®Â§ßËåÉÂõ¥ÂàÜ‰∫´Êó∂Ë¢´ÈáçÁΩÆ
        - ‰ªÖ‰æõÁßëÁ†î„ÄÅÊïôËÇ≤‰ΩøÁî®
        - ËØ∑ÈÅµÂæ™ÊÇ®ÊâÄÂú®ÂõΩÂÆ∂ÂíåÂú∞Âå∫ÁöÑÊ≥ïÂæãÊ≥ïËßÑ
        
        ---
        *Áî±GitHub ActionsËá™Âä®ÁîüÊàê | Êï∞ÊçÆÊù•Ê∫ê: [wzdnzd/aggregator#91](${{ env.GITHUB_ISSUE_URL }})*
        EOF
        echo "üìã Ê±áÊÄªÊä•ÂëäÂ∑≤ÁîüÊàê: $SUMMARY_FILE"
        
    - name: Êèê‰∫§Êõ¥Êîπ
      if: env.success == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Actions Bot"
        
        git add content/ logs/ api_summary.md issue_content.txt
        if git diff --staged --quiet; then
          echo "üìù Ê≤°ÊúâÂÜÖÂÆπÊõ¥ÊîπÔºåË∑≥ËøáÊèê‰∫§"
        else
          COMMIT_MSG="ü§ñ Ëá™Âä®Êõ¥Êñ∞APIÂÜÖÂÆπ (Clash + V2Ray) - $(date '+%Y-%m-%d %H:%M:%S')"
          git commit -m "$COMMIT_MSG"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push origin HEAD:${{ github.ref_name }}
          echo "‚úÖ ÂÜÖÂÆπÂ∑≤Êõ¥Êñ∞Âπ∂Êé®ÈÄÅÂà∞‰ªìÂ∫ì"
        fi
        
    - name: ËæìÂá∫ÊúÄÁªàÁªìÊûú
      if: always()
      run: |
        echo "==================== ÊâßË°åÁªìÊûú ===================="
        if [ "${{ env.success }}" = "true" ]; then
          echo "üéâ ‰ªªÂä°ÊâßË°åÊàêÂäüÔºÅ"
          echo "üîó APIÂú∞ÂùÄ: ${{ steps.scrape.outputs.api_url }}"
          echo "üîë ‰ΩøÁî®Token: ${{ steps.scrape.outputs.token }}"
          echo "üéØ Ëé∑ÂèñÊ†ºÂºè: Clash + V2Ray"
          echo "‚úÖ ÊàêÂäü: ${{ env.success_count }} ‰∏™"
          echo "‚ùå Â§±Ë¥•: ${{ env.fail_count }} ‰∏™"
          echo "üìÅ ÁîüÊàêÊñá‰ª∂: ${{ env.filenames }}"
          echo "üíæ ÊÄªÂ§ßÂ∞è: ${{ env.total_size }} Â≠óËäÇ"
          echo "üìã Ê±áÊÄªÊä•Âëä: api_summary.md"
          echo "üìù ËØ∑Ê±ÇÊó•Âøó: logs/request_log.txt"
          echo "üé≤ ËäÇÁÇπËØ¥Êòé: ÊØèÊ†ºÂºèÈöèÊú∫ËøîÂõû100‰∏™ÔºåÊØè4Â∞èÊó∂Êõ¥Êñ∞"
          echo "üìù Â∑≤ÁßªÈô§ÊâÄÊúâÂÖÉÊï∞ÊçÆÊ≥®ÈáäÔºåÈÖçÁΩÆÊñá‰ª∂‰∏∫Á∫ØÂáÄAPIÂìçÂ∫î"
        else
          echo "‚ùå ‰ªªÂä°ÊâßË°åÂ§±Ë¥•"
          echo "üîç ËØ∑Ê£ÄÊü•Êó•ÂøóËé∑ÂèñËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØ"
          echo "üìù ËØ∑Ê±ÇÊó•Âøó: logs/request_log.txt"
        fi
        echo "=================================================="
